// == Importing from MicroSoft Word
:experimental:
:url-pandoc: http://pandoc.org
:url-ant: http://ant.apache.org/
:url-google-asciidoc: https://chrome.google.com/webstore/detail/asciidoc-processor/eghlmnhjljbjodpeehjjcgfcjegcfbhk/
:url-google-asciidoc-source:  https://github.com/Mogztter/asciidoc-googledocs-addon/

=== Simple Pandoc

Pandoc ({url-pandoc}) is a swiss army knife for converting file formats, and makes a good job of simple docx files.
Use this command line:

 $ pandoc --wrap=none --atx-headers --normalize --extract-media=build/images input.docx > output.adoc

then edit the output file to tidy it up.

The conversions you can expect are shown in the table below (tested using MS Word 2010 and Windows Pandoc 1.16.0.2).

.Pandoc MS Word to AsciiDoc conversions
[cols="<20,<20"]
|====
|MS Word Feature |Conversion

|Heading (using MS Word Heading styles 1-5)
|Yes, except that auto-numbered headings produce invalid AsciiDoc due to a Pandoc bug.

|Tables
|Yes. 
Merged cells are unmerged. 
Column widths are ignored.

|Bulleted or numbered lists
|Yes

|Footnotes
|Yes

|Figure and table captions
|Normal paragraph

|Any other MS Word styled paragraphs
|Normal paragraph

|Embedded images
|Yes

|Character formating (bold, underline and italic)
|Yes

|Document automation (fields, auto-generated figure and table numbers)
|No - ignored

|Internal references (e.g. "See Figure 3")
|Plain text

|Drawing canvas
|Ignored

|Text boxes
|Ignored

|Linked (not embedded) images
|Ignored

|Vector graphics (MS Word "insert shape")
|Ignored

|====

=== Optimised Pandoc

The basic usage above is fine for one-off imports.
If you have lots to do, it is worth while cleaning the input document first, and automating the post-conversion tidy up.

// Is this egg sucking? I have just told the reader what is and isn't implemented, if he can drive Word he doesn't need me to tell him what to do.
// Are the comments helpful? Should they go into the text?

. Clean up the Word document:
// Title pages are usually easier to recreate manually
** Remove non-essential material (title pages, headers and footers, table of contents etc); it is usually easiest to copy just the body text into a new blank document
// Technically not necessary as Pandoc ignores them by default, but it simplifies the document, which is a good thing in principle
** Switch off tracking and accept all changes
// Important - Pandoc recognizes the style name to define headings
** Ensure you have used Heading styles for headings
// bug in 1.16.0.2
** Remove automatic heading numbering (this limitation may be removed in the next release of Pandoc)
// So you can turn them back into captions just with a .
** Ensure table titles are immediately *above* their table
// So you can turn them back into captions just with a .
** Ensure figure titles are immediately *above* their figure
// linked images are ignored (according to my testing)
** Ensure images are inserted as embedded files, not as links
// canvases are ignored (according to my testing)
** Remove canvases and put any images they contained into the main flow as paragraph images (this limitation may be removed in the next release of pandoc)
// results of SEQ formulas are ignored (MS Word inserts them to generate figure and table numbers)
** Replace all internal references and auto-generated sequence numbers with their literal values (kbd:[Ctrl+A], kbd:[Ctrl+Shift+F9])
// No - this will turn manually applied list formating back to plain text. Fine if you have used a list style though.
// * Remove all non style-based formating (kbd:[Ctrl+A], kbd:[Ctrl+space], kbd:[Ctrl+Q])
// text boxes are ignored (according to my testing)
** Remove text boxes and put their text into the main flow
// Back to plain text.
// Not sure about this - they don't show properly in PSPad, but look fine when converted to HTML.
** Replace special characters: smart quotes with simple quotes, non-breaking hyphens with normal hyphens.
** Remove all character formating (kbd:[Ctrl+A], kbd:[Ctrl+B], kbd:[Ctrl+B], kbd:[Ctrl+I], kbd:[Ctrl+I], kbd:[Ctrl+U], kbd:[Ctrl+U])
// pandoc just treats them as plain text as passes them through.
** Optional: insert ids and cross references using AsciiDoc notation
(You might find it easier doing it now rather than in the AsciiDoc document later.)
// Not sure if it is significant, but pandoc seems to be designed against this spec, rather than the normal docx.
** Save as "Strict Open-xml document (docx)"
. Convert using Pandoc as above
. Check that the output document looks OK, and that all images have been extracted.
If some images are missing, don't worry - you can extract them using a zip program (see the Ant fragments below).
. Fix up the output, preferably with an editor that can do regular expressions:
// tocs and cross refs introduce dozens of these. They are just noise.
* Delete automatic ids (those beginning with undererscore)
// Style issue - pandoc seems to extend the line to cover the longest row
* Replace long table delimiters with short ones.
// Style issue
* Insert line-breaks to get to 1 sentence per paragraph.
// can do this with a regexp, but is depends on exactly what format you used for them
* Re-insert images and turn caption paragraphs back into {adr} captions.
// can do this with a regexp, but is depends on exactly what format you used for them
* Replace the hard cross references with AsciiDoc references.
// checked vertical merge, assume h merge same
* Fix tables - merged cells will have unmerged, column widths need putting back.
. Try to convert it, and fix any errors that come up.
// pandoc supposedly only uses UTF-8, and the xml file is windows encoded, but I haven't found any problems so far.
// You definitely do get encoding errors if you go via HTML.
+
NOTE: Using this route, there _shouldn't_ be any encoding errors.
If there are, use the Ant `nativetoascii` task to make them visible as \NNNN codes.

// Examples are in Ant because that is what I use, an I don't know what else Windows has that can do this.
// Should I try to replicate it in something else?
// Should I give a cut-and-paste script? - No, it would probably cause lots of "it dont work" complaints. 
// Doing it in fragments makes it clear that it needs customising.

These {url-ant}[Apache Ant] task fragments automate some of these steps.

Extract image files:

TIP: docx is just a zip file with a docx file extension.
The images are always in the same place.

// Gets images from canvases as well, but not vector graphics
[source,xml]
----
<unzip src="${infile}" dest="build"/>
<copy todir="dist/images">
  <fileset dir="build/word/media"/>
</copy>
----

Run Pandoc:

[source,xml]
----
<exec executable="pandoc">
    <arg value="-f"/><arg value="docx"/>
    <arg value="-t"/><arg value="asciidoc"/>  
    <arg value="--wrap=none"/>
    <arg value="--atx-headers"/>
    <arg value="--normalize"/>
    <arg value="-o"/><arg value="${outfile}"/>
    <arg value="${infile}"/>
</exec>
----

Automate some of the editing steps (adjust the regexps to match your particular document):

[source,xml]
----
<!-- Delete automatically inserted ids -->
<replaceregexp
    file="${outfile}" 
    match="\[\[_.*]]"
    replace=""
    flags="g"/>

<!-- Shorten table delimiters -->
<replaceregexp
    file="${outfile}"
    match="\|==*"
    replace="|===="
    flags="g"/>

<!-- 1 sentence per line. Be careful not to match lists. It will get confused by abbreviations, but there is no way around that. -->
<replaceregexp
    file="${outfile}"
    match="(\w\w+)\.\s+(\w)"
    replace="\1.${line.separator}\2"
    flags="g"
    byline="true"/>

<!-- Replace figure captions with id and title -->
<replaceregexp
    file="@{outfile}"
    match="^Figure (\d?)*\s?(.*)"
    replace="[[fig-\1]]${line.separator}.\2${line.separator}"
    byline="true"/>

<!-- Replace references to figures with asciidoc xref -->
<replaceregexp
    file="@{outfile}"
    match="Figure (\d?)"
    replace="&lt;&lt;fig-\1&gt;&gt;"
    flags="g"/>
----

=== Other Tools

==== Google Docs
Google Docs can already upload and edit MS Word docx files.
With this addon from Guillaume Grossetie: {url-google-asciidoc}[AsciiDoc Processor]
you can copy and paste part or all of the document from Google Docs as AsciiDoc text. 
The features that it can handle seem to be slightly fewer than Pandoc, but expect further development.
The source for the addon is at {url-google-asciidoc-source}.

==== MS-DOS Text
// actually this is pretty good (if slow): you need a few more edits after compared to Pandoc, but it picks up text boxes, 
// leaves heading numbers in so you can reconstruct cross references, and substitutes special characters.
// The only real pain is tables which are converted to plain paragraphs, and images whaich are ignored.
If all else fails, save as MS-Dos text (no line breaks), and insert the AsciiDoc syntax manually.
