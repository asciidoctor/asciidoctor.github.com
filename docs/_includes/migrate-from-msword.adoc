// Included in user manual
// == Migrating from MicroSoft Word

=== Basic

Pandoc (http://pandoc.org) is a swiss army knife for converting file formats, and makes a good job of simple docx files. Use this command line:

 $ pandoc --wrap=none --atx-headers --normalize --extract-media=build/images input.docx > output.adoc

then edit the output file to tidy it up.

The conversions you can expect are shown in the table below (tested using Windows pandoc 1.16.0.2).

.Pandoc MS Word to AsciiDoc conversions
[cols="<20a,<20a"]
|====
|MS Word Feature |Conversion

|Heading (using MS Word Heading styles 1-5)
|Yes

WARNING: Auto numbered headings produce invalid AsciiDoc due to a pandoc bug.

|Table
|Yes. 
Merged cells are unmerged. 
Column widths are ignored.

|Bulleted or numbered list
|Yes

|Any other MS Word styled paragraph
|Normal paragraph

|Embedded image
|Yes

|Character formating (bold and italic)
|Yes

|Document automation (fields, auto-generated figure and table numbers)
|No - ignored

|Internal references (e.g. "See Figure 3")
|Plain text

|Figure and table captions
|Normal paragraph

|Text box
|Ignored

|Linked (not embedded) image
|Ignored

|Drawing canvas
|Ignored

|====

=== Bulk Import

The basic usage above is fine for one-off imports.
If you have many documents or large documents to convert, or if you want a 'clean' import so that the formating is applied by {adr} rather than read from the input, it is worth while massaging the input document first, and automating the tidy up.

. Clean up the Word document:
// Title pages are usually easier to recreate manually
** Remove non-essential material (title pages, headers and footers, table of contents etc); it is usually easiest to copy just the body text into a new blank document
// Technically not necessary but simplifies document, which is an all-round good thing
** Accept all changes and switch off tracking
// Important - pandoc recognizes the style name to define headings
** Ensure you have used Heading styles for headings
// bug in 1.16.0.2
** Remove automatic heading numbering (this limitation may be removed in the next release of pandoc)
// So you can turn them back into captions just with a .
** Ensure table titles are immediately *above* their table
// So you can turn them back into captions just with a .
** Ensure figure titles are immediately *above* their figure
// linked images are ignored (according to my testing)
** Ensure images are inserted as embedded files, not as links
// canvases are ignored (according to my testing)
** Remove canvases and put any images they contained into the main flow as paragraph images
// results of SEQ formulas are ignored
** Replace all internal references and auto-generated sequence numbers with their values (ctrl-a, ctrl-shift-F9)
// No - this will turn manuyally applied list formating back to normal. Fine if you have used a list style though.
// * Remove all non style-based formating (ctrl-a, ctrl-space, ctrl-q)
// Back to plain text
** Remove all character formating (ctrl-a, ctrl-i, ctrl-i, ctrl-b, ctrl-b)
// text boxes are ignored (according to my testing)
** Remove text boxes and put their text into the main flow
// pandoc just treats them as plain text as passes them through.
** Optional: insert ids and cross references using AsciiDoc notation. 
(You might find it quicker doing it now rather than in the AsciiDoc document later.)
// Not sure if it is significant, but pandoc seems to be designed against this spec, rather than the normal docx.
** Save it as "Strict open-xml document (docx)"
. Convert using pandoc as above.
. Check that the output document looks OK, and that the folder of images is complete.
If there are images missing, dont worry - you can extract them using a zip program (see the Ant task below).
. Fix up the output, preferably with an editor that can do regular expressions:
// This may be needed depending on how they fix the heading bug
// tocs and cross refs introduce dozens of these. 
// They are just noise.
* Delete any automatically generated ids (ones that begin with an underscore)
// Not sure about this - they dont show properly on PSPad, but look fine when converted to HTML.
* Replace smart quotes with simple quotes.
// Style issue
* Replace long table delimiters with short ones.
// Style issue
* Insert line-breaks to get to 1 sentence per paragraph.
// can do this with a regexp, but is depends on exactly what format you used for them
* Re-insert images and turn caption paragraphs back into {adr} captions.
// can do this with a regexp, but is depends on exactly what format you used for them
* Replace the hard cross references with AsciiDoc references.
// checked vertical merge, assume h merge same
* Fix tables - merged cells will have unmerged, column widths need putting back.
. Try to convert it, and fix any errors that come up.
// pandoc supposedly only uses UTF-8, and the xml file is windows encoded, but I havent found any problems so far.
// You definitely do get errors if you go via HTML.
+
NOTE: Using this route, there _shouldn't_ be any encoding errors.
If there are, use the Ant `nativetoascii` task to make them visible as \NNNN codes.

You can use Ant to automate some of these steps.

Extract image files:

docx is just a zip with a docx file extension.
The images are always in the same place.

[source,xml]
----
<unzip src="${infile}" dest="build"/>
<copy todir="dist/images">
  <fileset dir="build/word/media"/>
</copy>
----

Run pandoc:

[source,xml]
----
<exec executable="pandoc">
    <arg value="-f"/><arg value="docx"/>
    <arg value="-t"/><arg value="asciidoc"/>  
    <arg value="--wrap=none"/>
    <arg value="--atx-headers"/>
    <arg value="--normalize"/>
    <arg value="-o"/><arg value="${outfile}"/>
    <arg value="${infile}"/>
</exec>
----

Automate some of the editing steps (you will need to play with the regexps to match your particular document):

[source,xml]
----
<!-- Delete automatically inserted ids -->
<replaceregexp
    file="${outfile}" match="\[\[_.*]]" replace="" flags="g"/>

<!-- Shorten table delimiters -->
<replaceregexp 
    file="${outfile}" match="\|==*" replace="|====" flags="g"/>

<!-- 1 sentence per line. Be careful not to match lists. -->
<replaceregexp 
    file="${outfile}"
    match="(\w\w+)\.\s(\w)" 
    replace="\1.${line.separator}\2"
    flags="g" 
    byline="true"/>

<!-- Replace figure captions with id and title -->
<replaceregexp 
    file="@{outfile}" 
    match="^Figure (\d?)*\s?(.*)" 
    replace="[[fig-\1]]${line.separator}.\2${line.separator}" 
    byline="true"/>

<!-- Replace references to figures with asciidoc xref -->
<replaceregexp 
    file="@{outfile}" 
    match="Figure (\d?)" 
    replace="&lt;&lt;fig-\1&gt;&gt;" 
    flags="g"/>
----

=== Other Conversion Routes
If you don't have pandoc, save as MS-Dos text (no line breaks), and insert the AsciiDoc syntax manually.

